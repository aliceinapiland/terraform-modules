# Basic Apigee X Setup without VPC Peering

A minimal Apigee X setup without using VPC Peering. It also configures the northbound routing through
L7 External LoadBalancer and Private Service Connect's - Network Endpoint Group (PSC NEG).

Refer to below docs for more information.

- [Apigee Networking - Non-VPC Peering Option](https://cloud.google.com/apigee/docs/api-platform/get-started/networking-options#non-vpc-peering-architecture-overview)
- [Release Notes](https://cloud.google.com/apigee/docs/release-notes#August_26_2024)

<!-- BEGIN_SAMPLES_DEFAULT_SETUP_INSTRUCTIONS -->
## Setup Instructions

Set the project ID where you want your Apigee Organization to be deployed to.
You will also need to customize other variables specific to your environment.

Start by copying the example variables file:

```sh
# cd to samples/x-non-vpc-peering-xlb-hneg-ilb-psc or ensure you are in this directory
cp terraform.tfvars.example terraform.tfvars
```

Now, open `terraform.tfvars` and customize the variables. **Ensure you set `project_id` and review all other variables.**

To use a backend on Google Cloud Storage (GCS) for storing Terraform state (recommended for collaboration and consistency), set your chosen `PROJECT_ID` that will host the GCS bucket:
```sh
TF_STATE_PROJECT_ID=your-gcs-bucket-hosting-project-id # This can be the same or different from your Apigee project
```

Then, create the GCS bucket:
```sh
gsutil mb "gs://$TF_STATE_PROJECT_ID-tf"
```

Create a `terraform.tf` file with the backend configuration:

```sh
cat <<EOF >terraform.tf
terraform {
  required_providers {
    google = {
      source  = "hashicorp/google"
      version = ">= 5.0.0"
    }
  }
  backend "gcs" {
    bucket  = "$TF_STATE_PROJECT_ID-tf" # Use the project ID you chose for the TF state bucket
    prefix  = "terraform/state/x-non-vpc-peering-xlb-hneg-ilb-psc" # Added a more specific prefix
  }
}
EOF
```

Initialize Terraform (this will download providers and configure the backend):
```sh
terraform init
```

Validate your configuration by creating an execution plan:
```sh
terraform plan # This will automatically use terraform.tfvars if present
```

Provision all resources (this can take around 25-30 minutes):
```sh
terraform apply # This will automatically use terraform.tfvars if present
```
<!-- END_SAMPLES_DEFAULT_SETUP_INSTRUCTIONS -->

**Note:** The "Providers", "Modules", "Resources", "Inputs", and "Outputs" sections below are auto-generated by `terraform-docs`. They will need to be regenerated to reflect the latest changes in the Terraform configuration files (`main.tf`, `variables.tf`).

<!-- BEGIN_TF_DOCS -->
## Providers

| Name | Version |
|------|---------|
| <a name="provider_google"></a> [google](#provider\_google) | >= 5.0.0 |

## Modules

| Name | Source | Version |
|------|--------|---------|
| <a name="module_apigee-x-core"></a> [apigee-x-core](#module\_apigee-x-core) | ../../modules/apigee-x-core | n/a |
| <a name="module_project"></a> [project](#module\_project) | github.com/terraform-google-modules/cloud-foundation-fabric//modules/project | v28.0.0 |

## Resources

| Name | Type |
|------|------|
| [google_compute_address.region1-ilb-ip](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_address) | resource |
| [google_compute_firewall.apigee-vpc-fw-allow-health-check-ingress](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_firewall) | resource |
| [google_compute_firewall.apigee-vpc-fw-ilb-to-psc-neg-egress](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_firewall) | resource |
| [google_compute_firewall.apigee-vpc-fw-xlb-https-ingress](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_firewall) | resource |
| [google_compute_firewall.apigee-vpc-fw-xlb-to-hybrid-neg-ingress](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_firewall) | resource |
| [google_compute_global_address.apigee-xlb-ip](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_global_address) | resource |
| [google_compute_global_forwarding_rule.external_lb_forwarding_rule](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_global_forwarding_rule) | resource |
| [google_compute_health_check.apigee-xlb-hc-tcp](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_health_check) | resource |
| [google_compute_managed_ssl_certificate.apigee-xlb-ssl-certificate](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_managed_ssl_certificate) | resource |
| [google_compute_network.main_network](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_network) | resource |
| [google_compute_network_endpoint.region1-hybrid-neg-endpoint](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_network_endpoint) | resource |
| [google_compute_network_endpoint_group.region1-hybrid-neg](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_network_endpoint_group) | resource |
| [google_compute_region_backend_service.region1-ilb-bes](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_region_backend_service) | resource |
| [google_compute_region_network_endpoint_group.region1-psc_neg](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_region_network_endpoint_group) | resource |
| [google_compute_region_target_http_proxy.region1-ilb-targetproxy](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_region_target_http_proxy) | resource |
| [google_compute_region_url_map.region1-ilb-urlmap](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_region_url_map) | resource |
| [google_compute_subnetwork.region1-pos-subnet](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_subnetwork) | resource |
| [google_compute_subnetwork.region1-subnet](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_subnetwork) | resource |
| [google_compute_target_https_proxy.apigee-xlb-targetproxy](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_target_https_proxy) | resource |
| [google_compute_url_map.apigee-xlb-urlmap](https://registry.terraform.io/providers/hashicorp/google/latest/docs/resources/compute_url_map) | resource |

## Inputs

| Name | Description | Type | Default | Required |
|------|-------------|------|---------|:--------:|
| <a name="input_apigee-vpc-fw-allow-health-check-ingress-name"></a> [apigee-vpc-fw-allow-health-check-ingress-name](#input\_apigee-vpc-fw-allow-health-check-ingress-name) | Name for the VPC firewall rule allowing IPv4 GCP health check probes to reach load balancers. Must comply with GCP naming conventions. | `string` | `"apigee-vpc-fw-allow-health-check-ingress"` | no |
| <a name="input_apigee-vpc-fw-allow-health-check-ipv6-ingress-name"></a> [apigee-vpc-fw-allow-health-check-ipv6-ingress-name](#input\_apigee-vpc-fw-allow-health-check-ipv6-ingress-name) | Name for the VPC firewall rule allowing IPv6 GCP health check probes to reach load balancers. Must comply with GCP naming conventions. | `string` | `"apigee-vpc-fw-allow-health-check-ipv6-ingress"` | no |
| <a name="input_apigee-vpc-fw-hneg-http-ingress-name"></a> [apigee-vpc-fw-hneg-http-ingress-name](#input\_apigee-vpc-fw-hneg-http-ingress-name) | Name for the VPC firewall rule allowing HTTP ingress from the XLB to the Hybrid NEG and Regional ILB. Must comply with GCP naming conventions. | `string` | `"apigee-vpc-fw-hneg-http-ingress"` | no |
| <a name="input_apigee-vpc-fw-psc-https-egress-name"></a> [apigee-vpc-fw-psc-https-egress-name](#input\_apigee-vpc-fw-psc-https-egress-name) | Name for the VPC firewall rule allowing HTTPS egress from the Regional ILB to the PSC NEG and Apigee instance. Must comply with GCP naming conventions. | `string` | `"apigee-vpc-fw-psc-https-egress"` | no |
| <a name="input_apigee-vpc-fw-xlb-https-ingress-name"></a> [apigee-vpc-fw-xlb-https-ingress-name](#input\_apigee-vpc-fw-xlb-https-ingress-name) | Name for the VPC firewall rule allowing HTTPS ingress from the internet to the External Load Balancer. Must comply with GCP naming conventions. | `string` | `"apigee-vpc-fw-xlb-https-ingress"` | no |
| <a name="input_apigee-xlb-bes-name"></a> [apigee-xlb-bes-name](#input\_apigee-xlb-bes-name) | Name for the backend service of the External Load Balancer. Must comply with GCP naming conventions. | `string` | `"apigee-xlb-bes"` | no |
| <a name="input_apigee-xlb-hc-tcp-name"></a> [apigee-xlb-hc-tcp-name](#input\_apigee-xlb-hc-tcp-name) | Name for the TCP health check used by the External Load Balancer. Must comply with GCP naming conventions. | `string` | `"apigee-xlb-hc-tcp"` | no |
| <a name="input_apigee-xlb-https-fwd-rule-name"></a> [apigee-xlb-https-fwd-rule-name](#input\_apigee-xlb-https-fwd-rule-name) | Name for the HTTPS forwarding rule of the External Load Balancer. Must comply with GCP naming conventions. | `string` | `"apigee-xlb-https-fwd-rule"` | no |
| <a name="input_apigee-xlb-https-targetproxy-name"></a> [apigee-xlb-https-targetproxy-name](#input\_apigee-xlb-https-targetproxy-name) | Name for the HTTPS target proxy of the External Load Balancer. Must comply with GCP naming conventions. | `string` | `"apigee-xlb-https-targetproxy"` | no |
| <a name="input_apigee-xlb-ip-name"></a> [apigee-xlb-ip-name](#input\_apigee-xlb-ip-name) | Name for the static global IP address used by the External Load Balancer frontend. Must comply with GCP naming conventions. | `string` | `"apigee-xlb-ip"` | no |
| <a name="input_apigee-xlb-port"></a> [apigee-xlb-port](#input\_apigee-xlb-port) | Port number for the External HTTPS Application Load Balancer (frontend). | `number` | `443` | no |
| <a name="input_apigee-xlb-ssl-certificate-name"></a> [apigee-xlb-ssl-certificate-name](#input\_apigee-xlb-ssl-certificate-name) | Name for the SSL certificate used by the External Load Balancer. Must comply with GCP naming conventions. | `string` | `"apigee-xlb-ssl-certificate"` | no |
| <a name="input_apigee-xlb-urlmap-name"></a> [apigee-xlb-urlmap-name](#input\_apigee-xlb-urlmap-name) | Name for the URL map of the External Load Balancer. Must comply with GCP naming conventions. | `string` | `"apigee-xlb-urlmap"` | no |
| <a name="input_apigee_billing_type"></a> [apigee\_billing\_type](#input\_apigee\_billing\_type) | The billing type for the Apigee organization. Valid values are EVAL, PAYG, SUBSCRIPTION. | `string` | `"EVAL"` | no |
| <a name="input_apigee_envgroups"></a> [apigee\_envgroups](#input\_apigee\_envgroups) | A map of Apigee Environment Groups to create. Each group object defines a list of hostnames associated with it. | <pre>map(object({<br>    hostnames = list(string)<br>  }))</pre> | `{}` | no |
| <a name="input_apigee_environments"></a> [apigee\_environments](#input\_apigee\_environments) | A map of Apigee Environments to create. Each environment object defines properties like display name, description, node configuration, IAM bindings, associated environment groups, and type. | <pre>map(object({<br>    display_name = optional(string)<br>    description  = optional(string)<br>    node_config = optional(object({<br>      min_node_count = optional(number)<br>      max_node_count = optional(number)<br>    }))<br>    iam       = optional(map(list(string)))<br>    envgroups = list(string)<br>    type      = optional(string) # APIHUB, CONTROL_PLANE, ANALYTICS_AGENT, CONFIG_DEPLOYMENT, MESSAGE_PROCESSOR<br>  }))</pre> | `{}` | no |
| <a name="input_apigee_instances"></a> [apigee\_instances](#input\_apigee\_instances) | A map of Apigee instances to create. For EVAL organizations, only one instance is typically allowed. Each instance object defines its GCP region and associated environments. | <pre>map(object({<br>    region       = string<br>    environments = list(string)<br>  }))</pre> | `{}` | no |
| <a name="input_ax_region"></a> [ax\_region](#input\_ax\_region) | The Google Cloud region for storing Apigee analytics data. See https://cloud.google.com/apigee/docs/api-platform/get-started/install-cli for valid regions. | `string` | n/a | yes |
| <a name="input_billing_account"></a> [billing\_account](#input\_billing\_account) | The ID of the billing account to associate with the project. Required if project\_create is true. | `string` | `null` | no |
| <a name="input_network_name"></a> [network\_name](#input\_network\_name) | The name for the VPC network. Must comply with GCP naming conventions. | `string` | `"apigee-nb-nw"` | no |
| <a name="input_project_create"></a> [project\_create](#input\_project\_create) | Set to true to create a new Google Cloud project. If false, an existing project\_id must be provided. | `bool` | `false` | no |
| <a name="input_project_id"></a> [project\_id](#input\_project\_id) | The unique identifier for the Google Cloud project. This ID will also be used for the Apigee Organization if project\_create is true. | `string` | n/a | yes |
| <a name="input_project_parent"></a> [project\_parent](#input\_project\_parent) | The parent resource for the new project, specified in 'folders/folder\_id' or 'organizations/org\_id' format. Required if project\_create is true. | `string` | `null` | no |
| <a name="input_region1"></a> [region1](#input\_region1) | The primary GCP region for deploying regional resources like subnets and load balancers (e.g., 'us-east1'). | `string` | `"us-east1"` | no |
| <a name="input_region1-apigee-psc_target_service_attachment_uri"></a> [region1-apigee-psc\_target\_service\_attachment\_uri](#input\_region1-apigee-psc\_target\_service\_attachment\_uri) | The URI of the target Apigee Service Attachment for the PSC NEG in region1. Format: 'projects/SERVICE\_PRODUCER\_PROJECT/regions/REGION/serviceAttachments/MY\_SERVICE\_ATTACHMENT'. | `string` | `"projects/p54d5feba6873adbap-tp/regions/us-east1/serviceAttachments/apigee-us-east1-giy9"` | no |
| <a name="input_region1-hybrid-neg-name"></a> [region1-hybrid-neg-name](#input\_region1-hybrid-neg-name) | Name for the Hybrid Connectivity Network Endpoint Group (NEG) in region1. Must comply with GCP naming conventions. | `string` | `"apigee-us-east1-hybrid-neg"` | no |
| <a name="input_region1-ilb-bes-name"></a> [region1-ilb-bes-name](#input\_region1-ilb-bes-name) | Name for the backend service of the Regional ILB in region1. Must comply with GCP naming conventions. | `string` | `"apigee-us-east1-ilb-bes"` | no |
| <a name="input_region1-ilb-forwardingrule-name"></a> [region1-ilb-forwardingrule-name](#input\_region1-ilb-forwardingrule-name) | Name for the forwarding rule of the Regional ILB in region1. Must comply with GCP naming conventions. | `string` | `"apigee-us-east1-ilb-forwardingrule"` | no |
| <a name="input_region1-ilb-hc-name"></a> [region1-ilb-hc-name](#input\_region1-ilb-hc-name) | Name for the health check used by the Regional Internal Load Balancer (ILB) in region1. Must comply with GCP naming conventions. | `string` | `"apigee-us-east1-ilb-hc"` | no |
| <a name="input_region1-ilb-ip-name"></a> [region1-ilb-ip-name](#input\_region1-ilb-ip-name) | Name for the static internal IP address for the Regional ILB in region1. Must comply with GCP naming conventions. | `string` | `"apigee-us-east1-ilb-ip"` | no |
| <a name="input_region1-ilb-port"></a> [region1-ilb-port](#input\_region1-ilb-port) | Port number for the Regional Internal Load Balancer and the Hybrid NEG endpoint for backend communication. | `number` | `80` | no |
| <a name="input_region1-ilb-targetproxy-name"></a> [region1-ilb-targetproxy-name](#input\_region1-ilb-targetproxy-name) | Name for the target HTTP proxy of the Regional ILB in region1. Must comply with GCP naming conventions. | `string` | `"apigee-us-east1-ilb-targetproxy"` | no |
| <a name="input_region1-ilb-urlmap-name"></a> [region1-ilb-urlmap-name](#input\_region1-ilb-urlmap-name) | Name for the URL map of the Regional ILB in region1. Must comply with GCP naming conventions. | `string` | `"apigee-us-east1-ilb-urlmap"` | no |
| <a name="input_region1-pos-iprange"></a> [region1-pos-iprange](#input\_region1-pos-iprange) | The IPv4 address range for the proxy-only subnet in region1, in CIDR notation (e.g., '10.3.0.0/23'). This is used by the Regional Internal Load Balancer. | `string` | `"10.3.0.0/23"` | no |
| <a name="input_region1-proxy_only_subnet_name"></a> [region1-proxy\_only\_subnet\_name](#input\_region1-proxy\_only\_subnet\_name) | The name for the proxy-only subnet in region1. Required for the Regional Internal Application Load Balancer. Must comply with GCP naming conventions. | `string` | `"apigee-nb-nw-us-east1-pos"` | no |
| <a name="input_region1-psc-neg-name"></a> [region1-psc-neg-name](#input\_region1-psc-neg-name) | Name for the PSC Network Endpoint Group (NEG) in region1 that connects to the Apigee instance's service attachment. Must comply with GCP naming conventions. | `string` | `"apigee-us-east1-psc-neg"` | no |
| <a name="input_region1-subnet-iprange"></a> [region1-subnet-iprange](#input\_region1-subnet-iprange) | The primary IPv4 address range for the subnet in region1, in CIDR notation (e.g., '10.1.0.0/23'). | `string` | `"10.1.0.0/23"` | no |
| <a name="input_region1-subnet-name"></a> [region1-subnet-name](#input\_region1-subnet-name) | The name for the subnet in region1. Must comply with GCP naming conventions. | `string` | `"apigee-nb-nw-subnet-us-east1"` | no |
| <a name="input_region1-zone1"></a> [region1-zone1](#input\_region1-zone1) | The GCP zone within region1 for deploying zonal resources like the Hybrid NEG (e.g., 'us-east1-b'). | `string` | `"us-east1-b"` | no |
| <a name="input_us-west1-subnet-name"></a> [us-west1-subnet-name](#input\_us-west1-subnet-name) | The name for the subnet in the us-west1 region (example for multi-region setup, can be adapted or removed). Must comply with GCP naming conventions. | `string` | `"apigee-nb-nw-subnet-us-west1"` | no |

## Outputs

No outputs.
<!-- END_TF_DOCS -->
